# テストフレームワーク
 - テストケースをテストする

## 概要
 - ユーザーの動作（メニューから戦争選んで出発、戦闘をする）等をエミュレートするコントローラーを使ってテストケースを書き、動作が期待通りかどうかテストする
 - TestFramework/Scripts/testsディレクトリにperlスクリプトを入れておくとテストケースとして認識される。ディレクトリを階層化しても問題ない。
 - テストはtest_browser.cgiにアクセスし、スクリプトタブから選択して実行する
 - コントローラーはTestFramework/Controllerに\*Controllerの名前で入っている
 - テストのためのヘルパーもTestFramework/Controllerに入っている

## メリット
 - バグを発見しやすくなる
 - 先にテストケースを書いてから新しい機能を実装し、テストが成功するまで調整を繰り返す手法で開発出来る
 - 新機能を書きながら手動でデバッグする場合でも、途中までの処理をテストとして実行すれば自動化出来る(ユーティリティースクリプトとして書いても良い）
 - システム時刻を偽装したテストケースが書けるので、指定時間から始まるイベントなどのテストも出来る
 - BJ内部の処理に変更があってもコントローラーは内部処理をアクセッサーとして抽象化しているので、テストケースが再利用出来る
 - チェック項目を（部分的にでも）網羅するヘルパーを書けば様々なテストケースに適用出来る

## デメリット
 - テストケースを書くのが面倒
 - 全てのバグを発見出来るわけではない
 - 現在、bjの全機能のエミュレーションを実装したわけではないのでチェック出来ないことがある（必要に応じて追加予定）

## 使い方
 - test_browser.cgi?pass=passwardにブラウザからアクセスする
 - 手動タブからはコントローラーを直接操作出来る（実際は小さスクリプトを実行している）
 - スクリプトタブからはテストの実行や、ユーザーの全消去等のユーティリティースクリプトを実行できる
 - セーブ＆ロードタブからはゲームデータのセーブ＆ロードが行える

## テストの書き方
 - TestFramework/Scripts/tests/samplesにチュートリアル用のテストケースが入っているので参照

## 新しく追加された情勢をテストする例
 - 国をリセットして綺麗な状態にする
 - 何人かプレイヤーを作成し、国に士官させる
 - WorldControllerから$w{data}を書き換えられるので、新しい情勢の直前の年度を$w{year}に設定する
 - $w{game_lv}を1に設定し統一難易度をLv１にする
 - 国に所属するどれかのプレイヤーに戦争→勝利させ、統一させる
 - 新年度が新情勢かチェックする
 - 新情勢で最初に行われる動作をチェックする（全員ﾈﾊﾞﾗﾝ送りなら全員の所属国かﾈﾊﾞﾗﾝかどうか、混乱等なら混乱チェックが入ったプレイヤーは移動してないか、入っていないプレイヤーはﾈﾊﾞﾗﾝ送りになっていないか、投票状況や君主代表のチェック等）
 - 新情勢の進行をチェックする。（新情勢特有の動作や禁止ﾍﾟｯﾄが使えないか等）
 - 統一難易度を下げて誰かに戦争させる手法で統一処理を呼ぶ
 - 新情勢の終了後の処理をチェック（勝利国にアイテムが分配されるならチェック、祭り熟練等のチェック等、変わってはいけない値が変わってはないかチェック）
 - テスト終了
